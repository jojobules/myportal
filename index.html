<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的个人门户 v2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'] },
                    colors: { primary: '#007AFF', perplexity: '#22bfa0' },
                    boxShadow: { 'icon': '0 2px 5px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1)' },
                    animation: { 'fade-in': 'fadeIn 0.4s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F3F4F6;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out, background-color 0.5s ease;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .content-backdrop {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .search-input-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 15px rgba(31, 38, 135, 0.05);
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .status-dot { height: 8px; width: 8px; background-color: #ccc; border-radius: 50%; display: inline-block; }
        .status-dot.online { background-color: #34C759; box-shadow: 0 0 6px #34C759; }
        .status-dot.offline { background-color: #ccc; }
        .status-dot.syncing { background-color: #FF9500; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .ios-icon { border-radius: 22.5%; }
        .sortable-ghost { opacity: 0.4; background: rgba(255,255,255,0.5); }
        .sortable-drag { cursor: grabbing; transform: scale(1.05); }
        .text-readable { text-shadow: 0 1px 2px rgba(255,255,255,0.8); }
        .dark-bg .text-readable { text-shadow: 0 1px 2px rgba(0,0,0,0.1); color: #1a202c; }

        /* 抖动动画 (iOS Style) */
        @keyframes jiggle {
            0% { transform: rotate(-1.5deg); }
            50% { transform: rotate(1.5deg); }
            100% { transform: rotate(-1.5deg); }
        }
        .jiggle-mode .link-item {
            animation: jiggle 0.25s infinite;
            z-index: 10;
        }
        /* 整理模式下，图标禁止点击跳转，改为抓手 */
        .jiggle-mode a {
            pointer-events: none;
        }
    </style>
</head>
<body class="font-sans text-gray-800">

    <!-- Firebase SDK Setup -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
      }
    </script>

    <!-- 顶部 Ticker -->
    <div class="flex-none z-50 bg-white/80 backdrop-blur-sm border-b border-gray-200/50 shadow-sm">
        <div class="tradingview-widget-container w-full h-10">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
            {
            "symbols": [
                { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                { "proName": "FOREXCOM:NSXUSD", "title": "Nasdaq 100" },
                { "proName": "CBOE:VIX", "title": "VIX" },
                { "description": "USD/CAD", "proName": "FX_IDC:USDCAD" }
            ],
            "showSymbolLogo": true,
            "colorTheme": "light",
            "isTransparent": false, 
            "displayMode": "regular",
            "locale": "zh_CN"
            }
            </script>
        </div>
    </div>

    <!-- 右上角工具栏 -->
    <div class="fixed top-12 right-4 z-50 flex gap-2">
        <button onclick="openBackgroundModal()" class="bg-white/90 backdrop-blur hover:bg-white text-gray-600 hover:text-blue-600 font-medium py-1.5 px-3 rounded-full shadow border border-gray-200 transition-all flex items-center gap-1.5 text-xs active:scale-95">
            <i class="fa-solid fa-image"></i>
            <span>壁纸</span>
        </button>
        <button onclick="openSyncModal()" class="bg-white/90 backdrop-blur hover:bg-white text-gray-600 hover:text-primary font-medium py-1.5 px-3 rounded-full shadow border border-gray-200 transition-all flex items-center gap-1.5 text-xs active:scale-95">
            <span id="sync-status-dot" class="status-dot offline"></span>
            <span>数据</span>
        </button>
        <button onclick="openConverterModal()" class="bg-white/90 backdrop-blur hover:bg-white text-gray-600 hover:text-primary font-medium py-1.5 px-3 rounded-full shadow border border-gray-200 transition-all flex items-center gap-1.5 text-xs active:scale-95">
            <i class="fa-solid fa-calculator"></i>
            <span>换算</span>
        </button>
        <!-- 主编辑/添加按钮 -->
        <button onclick="toggleEditMode()" id="main-edit-btn" class="bg-white/90 backdrop-blur hover:bg-white text-primary font-medium w-8 h-8 rounded-full shadow border border-gray-200 flex items-center justify-center transition-all active:scale-90">
            <i class="fa-solid fa-pen" id="main-edit-icon"></i>
        </button>
    </div>

    <!-- 头部：HUD (时钟 + 天气) 和 搜索 -->
    <div class="flex-none flex flex-col items-center pt-4 pb-2 px-4">
        
        <!-- HUD 仪表盘 -->
        <div class="flex items-center gap-6 mb-4 select-none bg-white/40 backdrop-blur-sm px-6 py-2 rounded-2xl shadow-sm border border-white/40 transform scale-90 origin-bottom">
            <!-- 伦敦本地时间 -->
            <div class="flex flex-col items-center">
                <div id="clock-local" class="text-3xl font-bold text-gray-800 font-mono leading-none tracking-tight text-readable">00:00</div>
                <div class="text-[10px] text-gray-600 font-bold mt-1 uppercase tracking-wider">London, ON</div>
            </div>
            
            <div class="h-8 w-px bg-gray-400/30"></div>

            <!-- 北京时间 -->
            <div class="flex flex-col items-center">
                <div id="clock-cn" class="text-3xl font-bold text-gray-800 font-mono leading-none tracking-tight text-readable">00:00</div>
                <div class="text-[10px] text-gray-600 font-bold mt-1 uppercase tracking-wider">Beijing</div>
            </div>

            <div class="h-8 w-px bg-gray-400/30"></div>

            <!-- 天气组件 -->
            <div id="weather-widget" class="flex flex-col items-center cursor-pointer group" onclick="initWeather()" title="点击刷新">
                <div class="flex items-center gap-2 h-[30px]">
                    <i id="weather-icon" class="fa-solid fa-cloud text-xl text-gray-600 group-hover:text-blue-500 transition-colors filter drop-shadow-sm"></i>
                    <span id="weather-temp" class="text-2xl font-bold text-gray-800 text-readable">--°</span>
                </div>
                <div id="weather-desc" class="text-[10px] text-gray-600 font-bold mt-0 uppercase tracking-wider truncate max-w-[60px]">Weather</div>
            </div>
        </div>

        <!-- 搜索框 -->
        <div class="w-full max-w-xl relative z-10 flex flex-col gap-2">
            <!-- Google Search -->
            <form action="https://www.google.com/search" method="GET" target="_blank" class="group search-input-container rounded-full transition-all duration-300 hover:shadow-lg">
                <div class="flex items-center p-1">
                    <div class="pl-4 pr-3 text-gray-400 group-focus-within:text-blue-500 transition-colors">
                        <i class="fa-brands fa-google text-lg"></i>
                    </div>
                    <input type="text" name="q" placeholder="Google 搜索..." class="w-full bg-transparent border-none outline-none text-sm py-1.5 text-gray-800 placeholder-gray-400 h-8" autocomplete="off" required>
                    <button type="submit" class="bg-primary hover:bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition-all shadow-sm active:scale-95">
                        <i class="fa-solid fa-magnifying-glass text-xs"></i>
                    </button>
                </div>
            </form>

            <!-- Perplexity Search -->
            <form action="https://www.perplexity.ai/search" method="GET" target="_blank" class="group search-input-container rounded-full transition-all duration-300 hover:shadow-lg bg-white/80">
                <div class="flex items-center p-1">
                    <div class="pl-4 pr-3 text-gray-400 group-focus-within:text-teal-500 transition-colors w-10 flex justify-center">
                        <i class="fa-solid fa-brain text-sm"></i>
                    </div>
                    <input type="text" name="q" placeholder="Perplexity AI 搜索..." class="w-full bg-transparent border-none outline-none text-sm py-1.5 text-gray-800 placeholder-gray-400 h-8" autocomplete="off" required>
                    <button type="submit" class="bg-teal-500 hover:bg-teal-600 text-white rounded-full w-8 h-8 flex items-center justify-center transition-all shadow-sm active:scale-95">
                        <i class="fa-solid fa-arrow-right text-xs"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 主内容区 -->
    <main class="flex-1 overflow-y-auto custom-scroll w-full max-w-[1800px] mx-auto px-4 md:px-8 pb-10 mt-2" id="main-container">
        <!-- JS 生成内容 -->
    </main>

    <!-- 页脚 -->
    <div class="flex-none text-center py-2 text-[10px] text-gray-500/80 bg-white/30 backdrop-blur-md border-t border-white/20">
        Personal Portal &copy; 2025 | London, ON
    </div>

    <!-- =================== 弹窗区域 =================== -->

    <!-- 1. 背景设置 -->
    <div id="bg-modal" class="fixed inset-0 bg-black/20 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-5 transform scale-95 transition-all duration-200" id="bg-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-palette text-purple-500 mr-2"></i>个性化背景</h3>
                <button onclick="closeBgModal()" class="text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">纯色 / 渐变</label>
                    <div class="flex gap-2">
                        <button onclick="setBg('color', '#F3F4F6')" class="w-10 h-10 rounded-full bg-gray-100 border border-gray-300 shadow-sm hover:scale-110" title="默认灰"></button>
                        <button onclick="setBg('color', '#e0f2f1')" class="w-10 h-10 rounded-full bg-teal-50 border border-teal-200 shadow-sm hover:scale-110" title="薄荷绿"></button>
                        <button onclick="setBg('color', '#fff1f2')" class="w-10 h-10 rounded-full bg-rose-50 border border-rose-200 shadow-sm hover:scale-110" title="樱花粉"></button>
                        <button onclick="setBg('color', 'linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%)')" class="w-10 h-10 rounded-full shadow-sm hover:scale-110" style="background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%)" title="渐变白"></button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">网络壁纸</label>
                    <div class="grid grid-cols-3 gap-2">
                        <div onclick="setBg('image', 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1000')" class="h-16 rounded-lg bg-cover bg-center cursor-pointer hover:ring-2 ring-blue-500" style="background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=200')"></div>
                        <div onclick="setBg('image', 'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?q=80&w=1000')" class="h-16 rounded-lg bg-cover bg-center cursor-pointer hover:ring-2 ring-blue-500" style="background-image: url('https://images.unsplash.com/photo-1477346611705-65d1883cee1e?q=80&w=200')"></div>
                        <div onclick="setBg('image', 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=1000')" class="h-16 rounded-lg bg-cover bg-center cursor-pointer hover:ring-2 ring-blue-500" style="background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?q=80&w=200')"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-2">上传本地壁纸 (自动压缩)</label>
                    <div class="flex gap-2 items-center">
                        <input id="custom-bg-file" type="file" accept="image/*" class="block w-full text-xs text-gray-500 file:mr-2 file:py-2 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 bg-gray-50 rounded-lg">
                        <button onclick="handleLocalImageUpload()" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-xs hover:bg-blue-600 whitespace-nowrap min-w-[60px]">应用</button>
                    </div>
                    <p class="text-[10px] text-green-600 mt-1"><i class="fa-solid fa-check-circle"></i> 智能压缩已启用，可永久保存</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 添加/编辑链接 -->
    <div id="add-modal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 transition-all duration-200" id="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h3 id="modal-title" class="text-lg font-bold text-gray-800">添加应用</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <form id="add-link-form" onsubmit="handleLinkSubmit(event)">
                <input type="hidden" id="edit-link-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">名称</label>
                        <input id="site-name" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">网址</label>
                        <input id="site-url" type="url" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">分类</label>
                        <div class="relative">
                            <select id="site-category" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-3 py-2.5 text-sm appearance-none outline-none"></select>
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"><i class="fa-solid fa-chevron-down"></i></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between gap-3">
                    <button type="button" id="delete-btn" onclick="handleDeleteFromModal()" class="px-4 py-2.5 text-sm bg-red-50 text-red-500 hover:bg-red-100 rounded-xl hidden"><i class="fa-solid fa-trash-can"></i></button>
                    <div class="flex gap-2 flex-1">
                        <button type="button" onclick="closeModal()" class="flex-1 py-2.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-xl">取消</button>
                        <button type="submit" class="flex-1 py-2.5 text-sm text-white bg-primary hover:bg-blue-600 rounded-xl shadow-lg">保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. 数据与同步弹窗 (更新) -->
    <div id="sync-modal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-95 transition-all duration-200" id="sync-content">
            <div class="flex justify-between items-center mb-5">
                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-database text-primary mr-2"></i>数据中心</h3>
                <button onclick="closeSyncModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="space-y-6 text-sm">
                <!-- 本地备份/恢复 -->
                <div>
                    <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase">本地备份 (最便捷)</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData()" class="flex flex-col items-center justify-center p-3 bg-gray-50 hover:bg-blue-50 border border-gray-200 hover:border-blue-200 rounded-xl transition-all">
                            <i class="fa-solid fa-download text-lg text-blue-500 mb-1"></i>
                            <span class="text-xs font-medium text-gray-700">导出数据</span>
                        </button>
                        <button onclick="document.getElementById('import-file').click()" class="flex flex-col items-center justify-center p-3 bg-gray-50 hover:bg-green-50 border border-gray-200 hover:border-green-200 rounded-xl transition-all">
                            <i class="fa-solid fa-upload text-lg text-green-500 mb-1"></i>
                            <span class="text-xs font-medium text-gray-700">恢复备份</span>
                        </button>
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1.5 ml-1">无需服务器配置，直接导出文件并发送到新设备即可导入。</p>
                </div>

                <div class="border-t border-gray-100"></div>

                <!-- 云端同步 (Firebase) -->
                <div>
                    <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase">云端实时同步 (Firebase)</h4>
                    <div class="bg-blue-50 text-blue-700 p-3 rounded-lg text-xs mb-3">
                        <i class="fa-solid fa-info-circle mr-1"></i> 适合有开发经验的用户。
                    </div>
                    <input id="sync-id" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2" placeholder="Sync ID (自定义密码)">
                    <textarea id="firebase-config-input" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 font-mono text-xs" placeholder="const firebaseConfig = { ... }"></textarea>
                    <div class="flex justify-end gap-2 mt-3">
                        <button onclick="clearSyncConfig()" class="px-3 py-1.5 text-xs text-red-500 hover:bg-red-50 rounded-lg">断开</button>
                        <button onclick="saveSyncConfig()" class="px-3 py-1.5 text-xs bg-primary text-white rounded-lg hover:bg-blue-600">连接</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. 换算弹窗 -->
    <div id="converter-modal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-95 transition-all duration-200 flex flex-col max-h-[80vh]" id="converter-content">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-800">换算工具</h3>
                <button onclick="closeConverterModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex border-b border-gray-100 mb-4 flex-shrink-0">
                <button onclick="switchConverterTab('weight')" id="tab-weight" class="flex-1 pb-2 border-b-2 border-primary font-bold text-primary text-xs">重量</button>
                <button onclick="switchConverterTab('length')" id="tab-length" class="flex-1 pb-2 text-gray-500 text-xs">长度</button>
                <button onclick="switchConverterTab('temp')" id="tab-temp" class="flex-1 pb-2 text-gray-500 text-xs">温度</button>
            </div>
            <div class="space-y-3 overflow-y-auto custom-scroll pr-1" id="converter-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, onSnapshot, setDoc } from "firebase/firestore";
        window.firebaseModules = { initializeApp, getFirestore, doc, onSnapshot, setDoc };
    </script>

    <script>
        // --- 核心数据 ---
        const CATEGORIES = [
            { id: 'fanshawe', name: '范莎学习', icon: 'fa-graduation-cap', color: 'text-blue-500' },
            { id: 'social-ent', name: '社交娱乐', icon: 'fa-gamepad', color: 'text-pink-500' },
            { id: 'shopping', name: '购物', icon: 'fa-bag-shopping', color: 'text-orange-500' },
            { id: 'cn-shopping', name: '中国购', icon: 'fa-cart-shopping', color: 'text-red-500' },
            { id: 'software', name: '软件工具', icon: 'fa-layer-group', color: 'text-indigo-500' }
        ];

        const DEFAULT_LINKS = [
            { id: '1', name: 'FanshaweOnline', url: 'https://www.fanshawec.ca/login', category: 'fanshawe' },
            { id: '2', name: 'WebAdvisor', url: 'https://webadvisor.fanshawec.ca/', category: 'fanshawe' },
            { id: '3', name: 'Amazon', url: 'https://www.amazon.ca', category: 'shopping' },
            { id: '4', name: '淘宝', url: 'https://www.taobao.com', category: 'cn-shopping' },
            { id: '5', name: 'ChatGPT', url: 'https://chat.openai.com', category: 'software' }
        ];

        let links = JSON.parse(localStorage.getItem('myPortalLinks_v2')) || DEFAULT_LINKS;
        let db = null;
        let syncUnsubscribe = null;
        let isEditMode = false; // 整理模式状态

        // --- DOM 引用 ---
        const mainContainer = document.getElementById('main-container');
        const categorySelectEl = document.getElementById('site-category');

        function init() {
            renderCategoryOptions();
            renderAllSections();
            startClock();
            initWeather();
            loadBgPreference();
            initSync();
            switchConverterTab('weight');
        }

        // --- 整理模式 (Edit Mode) ---
        window.toggleEditMode = function() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('main-edit-btn');
            const icon = document.getElementById('main-edit-icon');
            
            if (isEditMode) {
                document.body.classList.add('jiggle-mode');
                btn.classList.add('bg-orange-500', 'text-white', 'hover:bg-orange-600', 'border-transparent');
                btn.classList.remove('bg-white/90', 'text-primary', 'border-gray-200');
                icon.className = 'fa-solid fa-check';
            } else {
                document.body.classList.remove('jiggle-mode');
                btn.classList.remove('bg-orange-500', 'text-white', 'hover:bg-orange-600', 'border-transparent');
                btn.classList.add('bg-white/90', 'text-primary', 'border-gray-200');
                icon.className = 'fa-solid fa-pen';
            }
            renderAllSections(); 
        }

        // --- 1. 天气功能 ---
        async function initWeather() {
            const tempEl = document.getElementById('weather-temp');
            const iconEl = document.getElementById('weather-icon');
            const descEl = document.getElementById('weather-desc');
            const url = `https://api.open-meteo.com/v1/forecast?latitude=42.98&longitude=-81.25&current=temperature_2m,weather_code&timezone=America%2FNew_York`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                const current = data.current;
                tempEl.textContent = `${Math.round(current.temperature_2m)}°`;
                const code = current.weather_code;
                let iconClass = 'fa-cloud', descText = 'Cloudy', iconColor = 'text-gray-500';
                if (code === 0) { iconClass = 'fa-sun'; descText = '晴朗'; iconColor = 'text-yellow-500'; }
                else if (code >= 1 && code <= 3) { iconClass = 'fa-cloud-sun'; descText = '多云'; iconColor = 'text-blue-400'; }
                else if (code >= 45 && code <= 48) { iconClass = 'fa-smog'; descText = '有雾'; iconColor = 'text-gray-400'; }
                else if (code >= 51 && code <= 67) { iconClass = 'fa-cloud-rain'; descText = '下雨'; iconColor = 'text-blue-600'; }
                else if (code >= 71 && code <= 77) { iconClass = 'fa-snowflake'; descText = '下雪'; iconColor = 'text-sky-300'; }
                else if (code >= 95) { iconClass = 'fa-bolt'; descText = '雷暴'; iconColor = 'text-purple-600'; }
                iconEl.className = `fa-solid ${iconClass} text-xl ${iconColor} filter drop-shadow-sm transition-colors`;
                descEl.textContent = descText;
            } catch (e) {
                tempEl.textContent = '--'; descEl.textContent = 'Offline';
            }
        }

        // --- 2. 图片压缩 ---
        function compressImage(file, maxWidth = 1920, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }
        window.handleLocalImageUpload = async function() {
            const fileInput = document.getElementById('custom-bg-file');
            const file = fileInput.files[0];
            const btn = fileInput.nextElementSibling;
            if (file) {
                const originalText = btn.textContent; btn.textContent = "压缩中..."; btn.disabled = true;
                try {
                    const compressedData = await compressImage(file, 1920, 0.6);
                    setBg('image', compressedData);
                    btn.textContent = "成功!"; setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 1000);
                } catch (e) { alert("失败"); btn.textContent = originalText; btn.disabled = false; }
            }
        }

        // --- 背景管理 ---
        window.openBackgroundModal = function() { toggleModal('bg-modal', true); }
        window.closeBgModal = function() { toggleModal('bg-modal', false); }
        window.setBg = function(type, value) {
            const body = document.body;
            if (type === 'color') { body.style.backgroundImage = value.includes('gradient') ? value : 'none'; body.style.backgroundColor = value.includes('gradient') ? '' : value; } 
            else { body.style.backgroundImage = `url('${value}')`; }
            try { localStorage.setItem('portal_bg_pref', JSON.stringify({ type, value })); } catch (e) {}
            closeBgModal();
        }
        function loadBgPreference() { try { const pref = JSON.parse(localStorage.getItem('portal_bg_pref')); if (pref) setBg(pref.type, pref.value); } catch(e){} }

        // --- 渲染与常规逻辑 ---
        function renderAllSections() {
            mainContainer.innerHTML = '';
            CATEGORIES.forEach((cat, index) => {
                const catLinks = links.filter(l => l.category === cat.id);
                const section = document.createElement('section');
                section.className = 'animate-fade-in mb-1';
                section.style.animationDelay = `${index * 0.05}s`;
                
                const grid = document.createElement('div');
                grid.dataset.categoryId = cat.id;
                grid.className = 'content-backdrop p-3 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-2 min-h-[60px]';

                catLinks.forEach(link => {
                    const card = document.createElement('div');
                    card.className = 'link-item group relative flex flex-col items-center gap-1 cursor-pointer select-none p-1 rounded-lg hover:bg-white/40 transition-colors';
                    card.dataset.id = link.id;
                    if(isEditMode) { card.setAttribute('onclick', `openEditModal(event, '${link.id}')`); }

                    card.innerHTML = `
                        <a href="${isEditMode ? 'javascript:void(0)' : link.url}" target="${isEditMode ? '' : '_blank'}" class="w-10 h-10 bg-white ios-icon shadow-icon border border-gray-100 flex items-center justify-center overflow-hidden transition-transform duration-300 group-hover:scale-110 group-active:scale-95 relative">
                            <img src="${getFavicon(link.url)}" alt="${link.name}" class="w-6 h-6 object-contain" onerror="this.src='https://www.google.com/s2/favicons?domain=google.com&sz=64'">
                            ${isEditMode ? '<div class="absolute inset-0 bg-black/10 flex items-center justify-center"><i class="fa-solid fa-pencil text-white drop-shadow-md text-xs"></i></div>' : ''}
                        </a>
                        <span class="text-[10px] font-medium text-gray-700 text-center truncate w-full leading-tight text-readable">${link.name}</span>
                    `;
                    grid.appendChild(card);
                });

                if (isEditMode || catLinks.length === 0) {
                    const addBtn = document.createElement('div');
                    addBtn.className = 'flex flex-col items-center gap-1 cursor-pointer select-none p-1 rounded-lg hover:bg-white/40 transition-colors';
                    addBtn.setAttribute('onclick', `openModalWithCategory('${cat.id}')`);
                    addBtn.innerHTML = `
                        <div class="w-10 h-10 border-2 border-dashed border-gray-300/80 rounded-2xl flex items-center justify-center text-gray-400 hover:text-primary hover:border-primary transition-colors bg-white/30">
                            <i class="fa-solid fa-plus text-sm"></i>
                        </div>
                        <span class="text-[10px] font-medium text-gray-500 text-center w-full leading-tight">添加</span>
                    `;
                    grid.appendChild(addBtn);
                }
                
                section.innerHTML = `<div class="flex items-center gap-2 mb-1 px-1"><i class="fa-solid ${cat.icon} ${cat.color} text-xs"></i><h2 class="text-xs font-bold text-gray-600 uppercase tracking-wider">${cat.name}</h2></div>`;
                section.appendChild(grid);
                mainContainer.appendChild(section);

                new Sortable(grid, { group: 'shared', animation: 200, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', delay: 100, delayOnTouchOnly: true, onEnd: handleDragEnd });
            });
        }

        // --- 工具函数 ---
        function getFavicon(url) { try { return `https://www.google.com/s2/favicons?domain=${new URL(url).hostname}&sz=64`; } catch { return 'https://www.google.com/s2/favicons?domain=google.com&sz=64'; } }
        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock-local').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                const cnTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
                document.getElementById('clock-cn').textContent = `${String(cnTime.getHours()).padStart(2,'0')}:${String(cnTime.getMinutes()).padStart(2,'0')}`;
            };
            update(); setInterval(update, 1000);
        }

        // --- CRUD 操作 ---
        window.handleLinkSubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('edit-link-id').value;
            const name = document.getElementById('site-name').value;
            let url = document.getElementById('site-url').value;
            const category = document.getElementById('site-category').value;
            if (!url.startsWith('http')) url = 'https://' + url;
            if (id) { const idx = links.findIndex(l => l.id === id); if (idx > -1) links[idx] = { ...links[idx], name, url, category }; } 
            else { links.push({ id: Date.now().toString(), name, url, category }); }
            saveData(); renderAllSections(); closeModal();
        }
        window.openEditModal = function(e, id) {
            e.stopPropagation(); const link = links.find(l => l.id === id); if (!link) return;
            document.getElementById('edit-link-id').value = link.id; document.getElementById('site-name').value = link.name;
            document.getElementById('site-url').value = link.url; document.getElementById('site-category').value = link.category;
            document.getElementById('modal-title').textContent = "修改应用"; 
            document.getElementById('delete-btn').classList.remove('hidden'); 
            openModal(true);
        }
        window.handleDeleteFromModal = function() {
             const id = document.getElementById('edit-link-id').value;
             if(id && confirm('确定要删除吗?')) {
                 links = links.filter(l => l.id !== id);
                 saveData(); renderAllSections(); closeModal();
             }
        }
        window.handleDragEnd = function() {
            const newLinks = [];
            document.querySelectorAll('[data-category-id]').forEach(grid => {
                const catId = grid.dataset.categoryId;
                grid.querySelectorAll('.link-item').forEach(card => {
                    const original = links.find(l => l.id === card.dataset.id);
                    if (original) { original.category = catId; newLinks.push(original); }
                });
            });
            links = newLinks; saveData(); setTimeout(renderAllSections, 50);
        }
        function saveData(skipCloud = false) { localStorage.setItem('myPortalLinks_v2', JSON.stringify(links)); if (!skipCloud) uploadToCloud(); }

        // --- 数据导入导出 (新功能) ---
        window.exportData = function() {
            const dataStr = JSON.stringify(links, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portal_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedLinks = JSON.parse(e.target.result);
                    if (Array.isArray(importedLinks)) {
                        if(confirm('导入将覆盖当前所有链接，确定继续吗？')) {
                            links = importedLinks;
                            saveData();
                            renderAllSections();
                            alert('导入成功！');
                            closeSyncModal();
                        }
                    } else {
                        alert('文件格式错误');
                    }
                } catch (err) {
                    alert('无法解析文件');
                }
                input.value = ''; // 重置 input
            };
            reader.readAsText(file);
        }

        // --- 模态框控制 ---
        function toggleModal(id, show) {
            const m = document.getElementById(id), c = m.firstElementChild;
            if (show) { m.classList.remove('hidden'); m.classList.add('flex'); setTimeout(() => { m.classList.remove('opacity-0'); c.classList.remove('scale-95'); c.classList.add('scale-100'); }, 10); }
            else { m.classList.add('opacity-0'); c.classList.remove('scale-100'); c.classList.add('scale-95'); setTimeout(() => { m.classList.remove('flex'); m.classList.add('hidden'); }, 200); }
        }
        window.openModal = function(isEdit=false) { 
            if(!isEdit) { 
                document.getElementById('add-link-form').reset(); 
                document.getElementById('edit-link-id').value=''; 
                document.getElementById('modal-title').textContent="添加应用"; 
                document.getElementById('delete-btn').classList.add('hidden'); 
            } 
            toggleModal('add-modal', true); 
        }
        window.closeModal = function() { toggleModal('add-modal', false); }
        window.openSyncModal = function() { toggleModal('sync-modal', true); }
        window.closeSyncModal = function() { toggleModal('sync-modal', false); }
        window.openConverterModal = function() { toggleModal('converter-modal', true); }
        window.closeConverterModal = function() { toggleModal('converter-modal', false); }
        window.openModalWithCategory = function(id) { openModal(); document.getElementById('site-category').value = id; }
        function renderCategoryOptions() { categorySelectEl.innerHTML = ''; CATEGORIES.forEach(cat => { const opt = document.createElement('option'); opt.value = cat.id; opt.textContent = cat.name; categorySelectEl.appendChild(opt); }); }
        document.querySelectorAll('.fixed').forEach(m => m.addEventListener('click', e => { if(e.target===m) toggleModal(m.id, false); }));

        // --- 同步逻辑 ---
        async function initSync() {
            const cfg = localStorage.getItem('portal_firebase_config'), sid = localStorage.getItem('portal_sync_id');
            if (cfg && sid) try { connectToFirebase(JSON.parse(cfg), sid); document.getElementById('firebase-config-input').value = JSON.stringify(JSON.parse(cfg),null,2); document.getElementById('sync-id').value = sid; } catch(e){}
        }
        async function connectToFirebase(config, syncId) {
            if (!window.firebaseModules) { setTimeout(() => connectToFirebase(config, syncId), 500); return; }
            try {
                updateSyncStatus('syncing'); const { initializeApp, getFirestore, doc, onSnapshot, setDoc } = window.firebaseModules;
                try { initializeApp(config); } catch(e){}
                db = getFirestore();
                if (syncUnsubscribe) syncUnsubscribe();
                syncUnsubscribe = onSnapshot(doc(db, "portals", syncId), (doc) => {
                    updateSyncStatus('online');
                    if (doc.exists() && JSON.stringify(doc.data().links) !== JSON.stringify(links)) { links = doc.data().links; saveData(true); renderAllSections(); }
                }, () => updateSyncStatus('offline'));
            } catch(e) { updateSyncStatus('offline'); }
        }
        window.saveSyncConfig = function() {
            try {
                let s = document.getElementById('firebase-config-input').value.trim();
                if (s.includes('=')) s = s.split('=')[1].trim(); if (s.endsWith(';')) s = s.slice(0,-1).trim();
                const cfg = new Function('return '+s)(), sid = document.getElementById('sync-id').value.trim();
                localStorage.setItem('portal_firebase_config', JSON.stringify(cfg)); localStorage.setItem('portal_sync_id', sid);
                connectToFirebase(cfg, sid); closeSyncModal();
            } catch(e) { alert("配置错误"); }
        }
        window.clearSyncConfig = function() {
            if(confirm('断开?')) { localStorage.removeItem('portal_firebase_config'); localStorage.removeItem('portal_sync_id'); if(syncUnsubscribe) syncUnsubscribe(); db=null; updateSyncStatus('offline'); closeSyncModal(); }
        }
        function uploadToCloud() {
            if (!db || !localStorage.getItem('portal_sync_id')) return;
            const { doc, setDoc } = window.firebaseModules;
            updateSyncStatus('syncing');
            setDoc(doc(db, "portals", localStorage.getItem('portal_sync_id')), { links, updatedAt: new Date().toISOString() }).then(()=>setTimeout(()=>updateSyncStatus('online'),500));
        }
        function updateSyncStatus(s) { const d = document.getElementById('sync-status-dot'); d.className=`status-dot ${s}`; d.nextElementSibling.textContent=s==='online'?'已同步':(s==='syncing'?'同步中':'未连接'); }

        // --- 换算逻辑 ---
        window.switchConverterTab = function(t) {
            ['weight','length','temp'].forEach(k => document.getElementById(`tab-${k}`).className = k===t ? 'flex-1 pb-2 border-b-2 border-primary font-bold text-primary text-xs' : 'flex-1 pb-2 text-gray-500 text-xs');
            const inp = (id,l) => `<div class="bg-gray-50 p-2 rounded-lg border border-gray-200"><label class="block text-[10px] text-gray-400 uppercase">${l}</label><input type="number" id="${id}" class="w-full bg-transparent border-none outline-none font-mono text-sm font-bold text-gray-700" placeholder="0"></div>`;
            let h = '<div class="space-y-2">';
            if(t==='weight') h+=`<div class="grid grid-cols-2 gap-2">${inp('c-w-1','KG')}${inp('c-w-2','LB')}</div><div class="grid grid-cols-2 gap-2">${inp('c-w-3','斤')}${inp('c-w-4','KG')}</div>`;
            else if(t==='length') h+=`<div class="grid grid-cols-2 gap-2">${inp('c-l-1','KM')}${inp('c-l-2','MI')}</div><div class="grid grid-cols-2 gap-2">${inp('c-l-3','M')}${inp('c-l-4','FT')}</div>`;
            else h+=`<div class="grid grid-cols-2 gap-2">${inp('c-t-1','°C')}${inp('c-t-2','°F')}</div>`;
            document.getElementById('converter-body').innerHTML = h + '</div>';
            bindConv(t);
        }
        function bindConv(t) {
            const set = (id,v) => document.getElementById(id).value = parseFloat(v).toFixed(2).replace(/\.00$/,'');
            if(t==='weight') {
                document.getElementById('c-w-1').oninput=e=>set('c-w-2',e.target.value*2.20462); document.getElementById('c-w-2').oninput=e=>set('c-w-1',e.target.value/2.20462);
                document.getElementById('c-w-3').oninput=e=>set('c-w-4',e.target.value*0.5); document.getElementById('c-w-4').oninput=e=>set('c-w-3',e.target.value/0.5);
            } else if(t==='length') {
                document.getElementById('c-l-1').oninput=e=>set('c-l-2',e.target.value*0.621371); document.getElementById('c-l-2').oninput=e=>set('c-l-1',e.target.value/0.621371);
                document.getElementById('c-l-3').oninput=e=>set('c-l-4',e.target.value*3.28084); document.getElementById('c-l-4').oninput=e=>set('c-l-3',e.target.value/3.28084);
            } else {
                document.getElementById('c-t-1').oninput=e=>set('c-t-2',e.target.value*1.8+32); document.getElementById('c-t-2').oninput=e=>set('c-t-1',(e.target.value-32)/1.8);
            }
        }

        init();
    </script>
</body>
</html>
